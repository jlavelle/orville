<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module    : Database.Orville.PostgreSQL.Internal.Monad
Copyright : Flipstone Technology Partners 2016-2018
License   : MIT
-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Monad</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Base</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadCatch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Except</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Reader</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">local</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runReaderT</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.State</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapStateT</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Pool</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.HDBC</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">withTransaction</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFail</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-27"></a><span class="hs-keyword">data</span><span> </span><a name="ConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier">ConnectionEnv</span></a></a><span> </span><a name="local-6989586621679070803"><a href="#local-6989586621679070803"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier">ConnectionEnv</span></a></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="ormTransactionOpen"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormTransactionOpen"><span class="hs-identifier">ormTransactionOpen</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormConnection"><span class="hs-identifier">ormConnection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679070803"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">data</span><span> </span><a name="QueryType"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier">QueryType</span></a></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SelectQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#SelectQuery"><span class="hs-identifier">SelectQuery</span></a></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InsertQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#InsertQuery"><span class="hs-identifier">InsertQuery</span></a></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UpdateQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#UpdateQuery"><span class="hs-identifier">UpdateQuery</span></a></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DeleteQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#DeleteQuery"><span class="hs-identifier">DeleteQuery</span></a></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DDLQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#DDLQuery"><span class="hs-identifier">DDLQuery</span></a></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">{-|
 'OrvilleEnv' tracks all the environment information required for an
 'OrvilleT conn m' Monad to operate. Use 'newOrvilleEnv' to construct
 one.
  -}</span><span>
</span><a name="line-45"></a><span class="hs-keyword">data</span><span> </span><a name="OrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier">OrvilleEnv</span></a></a><span> </span><a name="local-6989586621679070750"><a href="#local-6989586621679070750"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier">OrvilleEnv</span></a></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="ormEnvConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvConnectionEnv"><span class="hs-identifier">ormEnvConnectionEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679070750"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvStartTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvStartTransactionSQL"><span class="hs-identifier">ormEnvStartTransactionSQL</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvRunningQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvRunningQuery"><span class="hs-identifier">ormEnvRunningQuery</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679070802"><a href="#local-6989586621679070802"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679070802"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679070802"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvTransactionCallback"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvTransactionCallback"><span class="hs-identifier">ormEnvTransactionCallback</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier hs-type">TransactionEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvPool"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvPool"><span class="hs-identifier">ormEnvPool</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pool</span><span> </span><a href="#local-6989586621679070750"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">data</span><span> </span><a name="TransactionEvent"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier">TransactionEvent</span></a></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TransactionStart"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionStart"><span class="hs-identifier">TransactionStart</span></a></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TransactionCommit"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionCommit"><span class="hs-identifier">TransactionCommit</span></a></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TransactionRollback"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionRollback"><span class="hs-identifier">TransactionRollback</span></a></a><span>
</span><a name="line-57"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-identifier">defaultStartTransactionSQL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-60"></a><a name="defaultStartTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultStartTransactionSQL"><span class="hs-identifier">defaultStartTransactionSQL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;START TRANSACTION&quot;</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-identifier">setStartTransactionSQL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071165"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071165"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-63"></a><a name="setStartTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#setStartTransactionSQL"><span class="hs-identifier">setStartTransactionSQL</span></a></a><span> </span><a name="local-6989586621679071166"><a href="#local-6989586621679071166"><span class="hs-identifier">sql</span></a></a><span> </span><a name="local-6989586621679071167"><a href="#local-6989586621679071167"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071167"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvStartTransactionSQL</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071166"><span class="hs-identifier hs-var">sql</span></a><span class="hs-special">}</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-identifier">defaultRunningQuery</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071164"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071164"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-66"></a><a name="defaultRunningQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultRunningQuery"><span class="hs-identifier">defaultRunningQuery</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679071168"><a href="#local-6989586621679071168"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071168"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-identifier">defaultTransactionCallback</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier hs-type">TransactionEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><a name="defaultTransactionCallback"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultTransactionCallback"><span class="hs-identifier">defaultTransactionCallback</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-identifier">aroundRunningQuery</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-72"></a><span>     </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071163"><a href="#local-6989586621679071163"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071163"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071163"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071162"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-74"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071162"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-75"></a><a name="aroundRunningQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#aroundRunningQuery"><span class="hs-identifier">aroundRunningQuery</span></a></a><span> </span><a name="local-6989586621679071169"><a href="#local-6989586621679071169"><span class="hs-identifier">outside</span></a></a><span> </span><a name="local-6989586621679071170"><a href="#local-6989586621679071170"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071170"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvRunningQuery</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071171"><span class="hs-identifier hs-var">layeredAround</span></a><span class="hs-special">}</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-77"></a><span>    </span><span class="hs-identifier">layeredAround</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inside</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071173"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071173"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-78"></a><span>    </span><a name="local-6989586621679071171"><a href="#local-6989586621679071171"><span class="hs-identifier">layeredAround</span></a></a><span> </span><a name="local-6989586621679071174"><a href="#local-6989586621679071174"><span class="hs-identifier">queryType</span></a></a><span> </span><a name="local-6989586621679071175"><a href="#local-6989586621679071175"><span class="hs-identifier">sql</span></a></a><span> </span><a name="local-6989586621679071176"><a href="#local-6989586621679071176"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-79"></a><span>      </span><a href="#local-6989586621679071169"><span class="hs-identifier hs-var">outside</span></a><span> </span><a href="#local-6989586621679071174"><span class="hs-identifier hs-var">queryType</span></a><span> </span><a href="#local-6989586621679071175"><span class="hs-identifier hs-var">sql</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071172"><span class="hs-identifier hs-var">inside</span></a><span> </span><a href="#local-6989586621679071174"><span class="hs-identifier hs-var">queryType</span></a><span> </span><a href="#local-6989586621679071175"><span class="hs-identifier hs-var">sql</span></a><span> </span><a href="#local-6989586621679071176"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621679071172"><a href="#local-6989586621679071172"><span class="hs-identifier">inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ormEnvRunningQuery</span><span> </span><a href="#local-6989586621679071170"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-identifier">addTransactionCallBack</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-83"></a><span>     </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier hs-type">TransactionEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071161"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071161"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-84"></a><a name="addTransactionCallBack"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#addTransactionCallBack"><span class="hs-identifier">addTransactionCallBack</span></a></a><span> </span><a name="local-6989586621679071177"><a href="#local-6989586621679071177"><span class="hs-identifier">callback</span></a></a><span> </span><a name="local-6989586621679071178"><a href="#local-6989586621679071178"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-85"></a><span>  </span><a href="#local-6989586621679071178"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvTransactionCallback</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071179"><span class="hs-identifier hs-var">wrappedCallback</span></a><span class="hs-special">}</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-87"></a><span>    </span><a name="local-6989586621679071179"><a href="#local-6989586621679071179"><span class="hs-identifier">wrappedCallback</span></a></a><span> </span><a name="local-6989586621679071180"><a href="#local-6989586621679071180"><span class="hs-identifier">event</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-identifier">ormEnvTransactionCallback</span><span> </span><a href="#local-6989586621679071178"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679071180"><span class="hs-identifier hs-var">event</span></a><span>
</span><a name="line-89"></a><span>      </span><a href="#local-6989586621679071177"><span class="hs-identifier hs-var">callback</span></a><span> </span><a href="#local-6989586621679071180"><span class="hs-identifier hs-var">event</span></a><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">{-|
 'newOrvilleEnv' initialized an 'OrvilleEnv' for service. The connection
 pool provided will be used to obtain connections to the database ase
 required. You can use the 'Database.Orville.PostgreSQL.Connection.createConnectionPool'
 utility function to create a connection pool to a PosgreSQL server.
-}</span><span>
</span><a name="line-97"></a><span class="hs-identifier">newOrvilleEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pool</span><span> </span><a href="#local-6989586621679071160"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071160"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-98"></a><a name="newOrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#newOrvilleEnv"><span class="hs-identifier">newOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-99"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-var">OrvilleEnv</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-101"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultStartTransactionSQL"><span class="hs-identifier hs-var">defaultStartTransactionSQL</span></a><span>
</span><a name="line-102"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultRunningQuery"><span class="hs-identifier hs-var">defaultRunningQuery</span></a><span>
</span><a name="line-103"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultTransactionCallback"><span class="hs-identifier hs-var">defaultTransactionCallback</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-identifier">setConnectionEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679071159"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071159"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071159"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-106"></a><a name="setConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#setConnectionEnv"><span class="hs-identifier">setConnectionEnv</span></a></a><span> </span><a name="local-6989586621679071181"><a href="#local-6989586621679071181"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679071182"><a href="#local-6989586621679071182"><span class="hs-identifier">ormEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071182"><span class="hs-identifier hs-var">ormEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvConnectionEnv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679071181"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">}</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-keyword">newtype</span><span> </span><a name="OrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier">OrvilleT</span></a></a><span> </span><a name="local-6989586621679068779"><a href="#local-6989586621679068779"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679068780"><a href="#local-6989586621679068780"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679068781"><a href="#local-6989586621679068781"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier">OrvilleT</span></a></a><span>
</span><a name="line-109"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="unOrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#unOrvilleT"><span class="hs-identifier">unOrvilleT</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679068779"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679068780"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068781"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-110"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span>
</span><a name="line-111"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span>
</span><a name="line-112"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span>
</span><a name="line-113"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span>
</span><a name="line-114"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadPlus</span><span>
</span><a name="line-115"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span>
</span><a name="line-116"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span>
</span><a name="line-117"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span>
</span><a name="line-118"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span>
</span><a name="line-119"></a><span class="hs-cpp">#if MIN_VERSION_base (4,11,0)
</span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span>
</span><a name="line-121"></a><span class="hs-cpp">#endif
</span><span>             </span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">mapOrvilleT</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-125"></a><span>     </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071154"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071155"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071156"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071154"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071157"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071158"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071155"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071156"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071158"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071154"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071157"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-126"></a><a name="mapOrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#mapOrvilleT"><span class="hs-identifier">mapOrvilleT</span></a></a><span> </span><a name="local-6989586621679071183"><a href="#local-6989586621679071183"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><a name="local-6989586621679071184"><a href="#local-6989586621679071184"><span class="hs-identifier">action</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span> </span><a href="#local-6989586621679071183"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679071184"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">runOrville</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071151"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071152"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071153"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071151"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071152"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071153"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-129"></a><a name="runOrville"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#runOrville"><span class="hs-identifier">runOrville</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unOrvilleT</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-identifier">newConnectionEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679071150"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679071150"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-132"></a><a name="newConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#newConnectionEnv"><span class="hs-identifier">newConnectionEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-var">ConnectionEnv</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">withConnectionEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071147"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071148"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679071147"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071148"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071149"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071148"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071149"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-135"></a><a name="withConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnectionEnv"><span class="hs-identifier">withConnectionEnv</span></a></a><span> </span><a name="local-6989586621679071185"><a href="#local-6989586621679071185"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-136"></a><span>  </span><a name="local-6989586621679071186"><a href="#local-6989586621679071186"><span class="hs-identifier">ormEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ormEnvConnectionEnv</span><span> </span><a href="#local-6989586621679071186"><span class="hs-identifier hs-var">ormEnv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679071187"><a href="#local-6989586621679071187"><span class="hs-identifier">connected</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071185"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679071187"><span class="hs-identifier hs-var">connected</span></a><span>
</span><a name="line-139"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-140"></a><span>      </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">withResource</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ormEnvPool</span><span> </span><a href="#local-6989586621679071186"><span class="hs-identifier hs-var">ormEnv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679071188"><a href="#local-6989586621679071188"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679071189"><a href="#local-6989586621679071189"><span class="hs-identifier">connected</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#newConnectionEnv"><span class="hs-identifier hs-var">newConnectionEnv</span></a><span> </span><a href="#local-6989586621679071188"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-142"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier hs-var">localOrvilleEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679071186"><span class="hs-identifier hs-var">ormEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvConnectionEnv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679071189"><span class="hs-identifier hs-var">connected</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-143"></a><span>          </span><a href="#local-6989586621679071185"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679071189"><span class="hs-identifier hs-var">connected</span></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">withConnection</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071144"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071145"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071144"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071145"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071146"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071145"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071146"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-146"></a><a name="withConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-6989586621679071190"><a href="#local-6989586621679071190"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnectionEnv"><span class="hs-identifier hs-var">withConnectionEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071190"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ormConnection</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadTrans</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071126"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-149"></a><span>  </span><a name="local-8214565720323793700"><span class="hs-identifier">lift</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="#local-6989586621679071121"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679071122"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="#local-6989586621679071121"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071123"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071122"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-152"></a><span>  </span><a name="local-8214565720323793790"><span class="hs-identifier">throwError</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwError</span><span>
</span><a name="line-153"></a><span>  </span><a name="local-8214565720323793789"><span class="hs-identifier">catchError</span></a><span> </span><a name="local-6989586621679071124"><a href="#local-6989586621679071124"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679071125"><a href="#local-6989586621679071125"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-154"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">unOrvilleT</span><span> </span><a href="#local-6989586621679071124"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchError</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unOrvilleT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679071125"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadBase</span><span> </span><a href="#local-6989586621679071118"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679071119"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">MonadBase</span><span> </span><a href="#local-6989586621679071118"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071120"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071119"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-157"></a><span>  </span><a name="local-8214565720323822518"><span class="hs-identifier">liftBase</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">liftBase</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-comment">{-|
  'HasOrvilleContext' defines the operations that must be available in your own
  monad for managing the connection pool that Orville functions will use to
  access the database and manage transaction state. In most cases you can
  include 'OrvilleT' in your Monad stack and then automatically derive an
  instance of 'HasOrvilleContext'.

  You could also provide your own implementations of these functions
  instead of using 'OrvilleT', if that is the easiest approach for
  your Monad.
 -}</span><span>
</span><a name="line-170"></a><span class="hs-keyword">class</span><span> </span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679068776"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-171"></a><span>      </span><a name="HasOrvilleContext"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier">HasOrvilleContext</span></a></a><span> </span><a name="local-6989586621679068776"><a href="#local-6989586621679068776"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679068777"><a href="#local-6989586621679068777"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-172"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">conn</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-174"></a><span>  </span><a name="getOrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679068777"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679068776"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>  </span><span class="hs-comment">-- ^ getOrvilleEnv fetches the Orville environment from the Monad context.</span><span>
</span><a name="line-176"></a><span>  </span><span class="hs-comment">-- Analogous to 'ask' from the 'Reader' monad.</span><span>
</span><a name="line-177"></a><span>  </span><a name="localOrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679068776"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679068776"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679068777"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068778"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679068777"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068778"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-comment">-- ^ localOrvilleEnv locally modifies the Orville environment for the</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-comment">-- scope of the provided action. This allows Orville to track with</span><span>
</span><a name="line-179"></a><span>  </span><span class="hs-comment">-- a connection is acquired, open transactions, etc. Analogous to 'local'</span><span>
</span><a name="line-180"></a><span>  </span><span class="hs-comment">-- from the 'Reader' monad.</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-comment">{-|
   'MonadOrvilleControl' provides an interface for the kinds of IO operations
   that Orville functions need to lift into the Monad providing the
   'MonadOrville' instance. This typeclass allows users to provide their
   own lifting strategies in case the Monad stack in question has special
   needs. If you are only using 'ReaderT' and 'OrvilleT' layers in your
   monad stack, you can probably implement this for your own Monad wrapper
   type using the provided default functions and providing functions to
   wrap and unwrapper your Monad layer:

   @
    instance MonadOrvilleControl MyMonad where
      liftWithConnection = defaultLiftWithConnection wrapMyMonad unWrapMyMonad
      liftFinally = defaultLiftFinally wrapMyMonad unWrapMyMonad
   @

   If you are using transformers in your monad stack beyond 'ReaderT', they
   probably don't provide 'MonadOrvilleControl' instances (e.g. third party
   libraries). In this case, see 'Database.Orville.PostgreSQL.MonadUnliftIO' for more
   help. If you're still stuck (because your library doesn't support
   'MonadTransControl'), try 'Database.Orville.PostgreSQL.MonadBaseControl' instead. If
   you're *still* stuck after that, please file an issue on Github at
   https://github.com/flipstone/orville so we can can help out!
  -}</span><span>
</span><a name="line-206"></a><span class="hs-keyword">class</span><span> </span><a name="MonadOrvilleControl"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier">MonadOrvilleControl</span></a></a><span> </span><a name="local-6989586621679068768"><a href="#local-6989586621679068768"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-207"></a><span>  </span><a name="liftWithConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-208"></a><span>       </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679068771"><a href="#local-6989586621679068771"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679068769"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679068771"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679068771"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679068769"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679068768"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068770"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679068768"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068770"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-209"></a><span>  </span><a name="liftFinally"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679068774"><a href="#local-6989586621679068774"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679068775"><a href="#local-6989586621679068775"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679068774"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679068775"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679068774"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679068768"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068772"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679068768"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068773"><span class="hs-identifier hs-type">d</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679068768"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679068772"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-comment">{-|
  'MonadOrville' does not have any methods of its own. Instead it brings all
  the typeclass constraints required by Orville functions that need to access
  the database into a single typeclass. In some cases you can include
  'OrvilleT' in your Monad stack and then automatically derive an instance of
  'MonadOrville'. However, more likely you are using some third party monad
  somewhere in your stack that does not han a 'MonadOrvilleControl' instance.
  In this case you won't be able to derive 'MonadOrville', but providing a
  simple empty instance will do:

  @
    instance O.MonadOrville Postgres.Connection MyMonad
  @
 -}</span><span>
</span><a name="line-225"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679068745"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-226"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679068745"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-227"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679068744"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679068745"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-228"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679068745"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-229"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679068745"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-230"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span> </span><a href="#local-6989586621679068745"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-232"></a><span class="hs-cpp">#endif
</span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-234"></a><span>      </span><a name="MonadOrville"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier">MonadOrville</span></a></a><span> </span><a name="local-6989586621679068744"><a href="#local-6989586621679068744"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679068745"><a href="#local-6989586621679068745"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-238"></a><span>  </span><a name="local-8214565720323843458"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-239"></a><span>  </span><a name="local-8214565720323843459"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-comment">{-|
   defaultLiftWithConnection provides a simple definition of
   'liftWithConnection' for 'MonadOrvilleControl' instances when the Monad in
   question is a wrapper around a type that already implements
   'MonadOrvilleControl'
  -}</span><span>
</span><a name="line-247"></a><span class="hs-identifier">defaultLiftWithConnection</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-248"></a><span>     </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071137"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-249"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071141"><a href="#local-6989586621679071141"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071137"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071141"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071138"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071141"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071142"><a href="#local-6989586621679071142"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071138"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071142"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071137"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071142"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071143"><a href="#local-6989586621679071143"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071139"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071143"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071143"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071139"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071138"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071140"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071138"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071140"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-254"></a><a name="defaultLiftWithConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftWithConnection"><span class="hs-identifier">defaultLiftWithConnection</span></a></a><span> </span><a name="local-6989586621679071191"><a href="#local-6989586621679071191"><span class="hs-identifier">wrapT</span></a></a><span> </span><a name="local-6989586621679071192"><a href="#local-6989586621679071192"><span class="hs-identifier">unWrapT</span></a></a><span> </span><a name="local-6989586621679071193"><a href="#local-6989586621679071193"><span class="hs-identifier">ioWithConn</span></a></a><span> </span><a name="local-6989586621679071194"><a href="#local-6989586621679071194"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-255"></a><span>  </span><a href="#local-6989586621679071191"><span class="hs-identifier hs-var">wrapT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a><span> </span><a href="#local-6989586621679071193"><span class="hs-identifier hs-var">ioWithConn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071192"><span class="hs-identifier hs-var">unWrapT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679071194"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span class="hs-comment">{-|
   defaultLiftFinally provides a simple definition of
   'liftWithConnection' for 'MonadOrvilleControl' instances when the Monad in
   question is a wrapper around a type that already implements
   'MonadOrvilleControl'
  -}</span><span>
</span><a name="line-263"></a><span class="hs-identifier">defaultLiftFinally</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-264"></a><span>     </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071129"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071133"><a href="#local-6989586621679071133"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071129"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071133"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071130"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071133"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071134"><a href="#local-6989586621679071134"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071130"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071134"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071129"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071134"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071135"><a href="#local-6989586621679071135"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679071136"><a href="#local-6989586621679071136"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071135"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071136"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071135"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071130"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071131"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-269"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071130"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071132"><span class="hs-identifier hs-type">d</span></a><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071130"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071131"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-271"></a><a name="defaultLiftFinally"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftFinally"><span class="hs-identifier">defaultLiftFinally</span></a></a><span> </span><a name="local-6989586621679071195"><a href="#local-6989586621679071195"><span class="hs-identifier">wrapT</span></a></a><span> </span><a name="local-6989586621679071196"><a href="#local-6989586621679071196"><span class="hs-identifier">unWrapT</span></a></a><span> </span><a name="local-6989586621679071197"><a href="#local-6989586621679071197"><span class="hs-identifier">ioFinally</span></a></a><span> </span><a name="local-6989586621679071198"><a href="#local-6989586621679071198"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679071199"><a href="#local-6989586621679071199"><span class="hs-identifier">cleanup</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-272"></a><span>  </span><a href="#local-6989586621679071195"><span class="hs-identifier hs-var">wrapT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier hs-var">liftFinally</span></a><span> </span><a href="#local-6989586621679071197"><span class="hs-identifier hs-var">ioFinally</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071196"><span class="hs-identifier hs-var">unWrapT</span></a><span> </span><a href="#local-6989586621679071198"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071196"><span class="hs-identifier hs-var">unWrapT</span></a><span> </span><a href="#local-6989586621679071199"><span class="hs-identifier hs-var">cleanup</span></a><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-identifier">startTransactionSQL</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071127"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071128"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679071128"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-275"></a><a name="startTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#startTransactionSQL"><span class="hs-identifier">startTransactionSQL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ormEnvStartTransactionSQL</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071114"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679071115"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071114"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-278"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679071115"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="#local-6989586621679071116"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679071114"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-279"></a><span>  </span><a name="local-8214565720323843461"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-280"></a><span>  </span><a name="local-8214565720323843462"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><a name="local-6989586621679071117"><a href="#local-6989586621679071117"><span class="hs-identifier">modEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier hs-var">localOrvilleEnv</span></a><span> </span><a href="#local-6989586621679071117"><span class="hs-identifier hs-var">modEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-comment">-- ReaderT is trivial enough that we just provide a 'MonadOrvilleControl'</span><span>
</span><a name="line-283"></a><span class="hs-comment">-- instance for it here rather than relying on either MonadUnliftIO or</span><span>
</span><a name="line-284"></a><span class="hs-comment">-- MonadBaseControl at all. This allows Monad stacks that only use 'ReaderT'</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- and 'OrvilleT' over IO to be built without needing to know anything more</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- about lifting IO operations beyond the types in this module.</span><span>
</span><a name="line-287"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071105"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="#local-6989586621679071106"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679071105"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-288"></a><span>  </span><a name="local-8214565720323843458"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><a name="local-6989586621679071107"><a href="#local-6989586621679071107"><span class="hs-identifier">ioWithConn</span></a></a><span> </span><a name="local-6989586621679071108"><a href="#local-6989586621679071108"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679071109"><a href="#local-6989586621679071109"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-290"></a><span>      </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a><span> </span><a href="#local-6989586621679071107"><span class="hs-identifier hs-var">ioWithConn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679071109"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679071108"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>  </span><a name="local-8214565720323843459"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><a name="local-6989586621679071110"><a href="#local-6989586621679071110"><span class="hs-identifier">ioFinally</span></a></a><span> </span><a name="local-6989586621679071111"><a href="#local-6989586621679071111"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679071112"><a href="#local-6989586621679071112"><span class="hs-identifier">cleanup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679071113"><a href="#local-6989586621679071113"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-293"></a><span>      </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier hs-var">liftFinally</span></a><span> </span><a href="#local-6989586621679071110"><span class="hs-identifier hs-var">ioFinally</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679071111"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679071113"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679071112"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621679071113"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071102"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-296"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679071102"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-297"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679071102"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-298"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679071103"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-299"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071103"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071102"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-300"></a><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-301"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071103"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="#local-6989586621679071104"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679071102"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071100"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071101"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071100"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-304"></a><span>  </span><a name="local-8214565720323843458"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftWithConnection"><span class="hs-identifier hs-var">defaultLiftWithConnection</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-identifier">unOrvilleT</span><span>
</span><a name="line-305"></a><span>  </span><a name="local-8214565720323843459"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftFinally"><span class="hs-identifier hs-var">defaultLiftFinally</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-identifier">unOrvilleT</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679070939"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679070940"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-308"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679070939"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679070939"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679070940"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-309"></a><span>  </span><a name="local-8214565720323843461"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-310"></a><span>  </span><a name="local-8214565720323843462"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><a name="local-6989586621679071098"><a href="#local-6989586621679071098"><span class="hs-identifier">modEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><a name="local-6989586621679071099"><a href="#local-6989586621679071099"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">local</span><span> </span><a href="#local-6989586621679071098"><span class="hs-identifier hs-var">modEnv</span></a><span> </span><a href="#local-6989586621679071099"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679070937"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-313"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679070937"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-314"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679070937"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-315"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679070938"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-316"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679070937"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-317"></a><span class="hs-cpp">#if MIN_VERSION_base (4,11,0)
</span><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span> </span><a href="#local-6989586621679070937"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-319"></a><span class="hs-cpp">#endif
</span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-321"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679070938"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679070938"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679070937"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-comment">-- We can provide 'HasOrvilleContext' for 'StateT' here, but not 'MonadOrvilleControl'</span><span>
</span><a name="line-324"></a><span class="hs-comment">-- because we do not want to force a decision on the end use about how the 'StateT'</span><span>
</span><a name="line-325"></a><span class="hs-comment">-- state should be managed during control functions (e.g. 'liftFinally'). See the</span><span>
</span><a name="line-326"></a><span class="hs-comment">-- 'MonadBaseControl' module for an instance of 'MonadOrvilleControl' for 'StateT', if</span><span>
</span><a name="line-327"></a><span class="hs-comment">-- you are brave enough to use 'MonadBaseControl'.</span><span>
</span><a name="line-328"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679070804"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679070805"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679070804"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-329"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679070805"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="#local-6989586621679070806"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679070804"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-330"></a><span>  </span><a name="local-8214565720323843461"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-331"></a><span>  </span><a name="local-8214565720323843462"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><a name="local-6989586621679070936"><a href="#local-6989586621679070936"><span class="hs-identifier">modEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapStateT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier hs-var">localOrvilleEnv</span></a><span> </span><a href="#local-6989586621679070936"><span class="hs-identifier hs-var">modEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a></pre></body></html>